<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rsat">
<title>3. Customize • rsat</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="3. Customize">
<meta property="og:description" content="rsat">
<meta property="og:image" content="https://docs.ropensci.org/rsat/logo.png">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">rsat</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.19</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/rsat1_search.html">1. Search</a>
    <a class="dropdown-item" href="../articles/rsat2_download.html">2. Download</a>
    <a class="dropdown-item" href="../articles/rsat3_customize.html">3. Customize</a>
    <a class="dropdown-item" href="../articles/rsat4_process.html">4. Process</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/rsat/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>3. Customize</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/rsat/blob/HEAD/vignettes/rsat3_customize.Rmd" class="external-link"><code>vignettes/rsat3_customize.Rmd</code></a></small>
      <div class="d-none name"><code>rsat3_customize.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="customize">Customize<a class="anchor" aria-label="anchor" href="#customize"></a>
</h2>
<p><strong>Customizing</strong> means transforming raw images into useful information for particular needs. Customizing includes; (1) mosaicking, i.e. joining scenes of a region and date in a single file , (2) calculating and index to highlight the presence of process/material in the satellite image, and (3) mask the cloudy pixels to avoid misinterpreting the surface reflectance values. This demo builds on the showcase from the search vignette and so, the first section reviews the most important code from the previous vignette.</p>
<hr>
<div class="section level3">
<h3 id="review">Review<a class="anchor" aria-label="anchor" href="#review"></a>
</h3>
<p>As a first step of <code>rsat</code>’s workflow is specifying the credentials for the the web services:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rsat">rsat</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/set_credentials.html">set_credentials</a></span><span class="op">(</span><span class="st">"rsat.package"</span>,<span class="st">"UpnaSSG.2021"</span><span class="op">)</span></span></code></pre></div>
<p>The showcase aims at assessing the effect of the <a href="https://en.wikipedia.org/wiki/2020%E2%80%9321_European_windstorm_season#Storm_Filomena" class="external-link">Snowstorm Filomena</a> on the Iberian peninsula during January <span class="math inline">\(10^{th}\)</span> and <span class="math inline">\(15^{th}\)</span>, <span class="math inline">\(2021\)</span>. Hence, the <em>roi</em> and <em>toi</em> correspond to an <code>sf</code> polygon around the peninsula (<code>ip</code>) and a vector of dates (<code>toi</code>) covering the time-span:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ip</span> <span class="op">&lt;-</span> <span class="fu">st_sf</span><span class="op">(</span><span class="fu">st_as_sfc</span><span class="op">(</span><span class="fu">st_bbox</span><span class="op">(</span><span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span></span>
<span>  xmin <span class="op">=</span> <span class="op">-</span><span class="fl">9.755859</span>,</span>
<span>  xmax <span class="op">=</span>  <span class="fl">4.746094</span>,</span>
<span>  ymin <span class="op">=</span> <span class="fl">35.91557</span>,</span>
<span>  ymax <span class="op">=</span> <span class="fl">44.02201</span> </span>
<span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">toi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-10"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-15"</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>The folders for the database and dataset can be created programmatically as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db.path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"database"</span><span class="op">)</span></span>
<span><span class="va">ds.path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"datasets"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">db.path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">ds.path</span><span class="op">)</span></span></code></pre></div>
<p>The minimum information to generate a new <code>rtoi</code> is a <code>name</code> for the object, a polygon of the region of interest (<em>roi</em>), and the paths to the database and dataset:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filomena</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_rtoi.html">new_rtoi</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"filomena"</span>,</span>
<span>                     region <span class="op">=</span> <span class="va">ip</span>,</span>
<span>                     db_path <span class="op">=</span> <span class="va">db.path</span>,</span>
<span>                     rtoi_path <span class="op">=</span> <span class="va">ds.path</span><span class="op">)</span></span></code></pre></div>
<p>To limit the amount of data and processing times, the assessment is conducted over MODIS imagery. A total number of <span class="math inline">\(24\)</span> images are found for the region over the <span class="math inline">\(6\)</span>-day period:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rsat_search.html">rsat_search</a></span><span class="op">(</span>region <span class="op">=</span> <span class="va">filomena</span>, product <span class="op">=</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"mod09ga"</span><span class="op">)</span>, dates <span class="op">=</span> <span class="va">toi</span><span class="op">)</span></span></code></pre></div>
<p>The way to download the search results is as follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rsat_download.html">rsat_download</a></span><span class="op">(</span><span class="va">filomena</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
<div class="section level3">
<h3 id="mosaic">Mosaic<a class="anchor" aria-label="anchor" href="#mosaic"></a>
</h3>
<p><strong><em>Mosaicking</em></strong> involves binding together several images of a region from the same date. The function <code><a href="https://rspatial.github.io/terra/reference/mosaic.html" class="external-link">mosaic()</a></code> finds automatically the relevant images in the database and joins them together in a single file. Additionally, by default, the function crops around the <em>roi</em> of the <code>rtoi</code> to remove unnecessary information and save space on your hard disk drive:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rsat_mosaic.html">rsat_mosaic</a></span><span class="op">(</span><span class="va">filomena</span><span class="op">)</span></span></code></pre></div>
<p>The cropping option can be disabled with the argument <code>warp = NULL</code>. Here, cropping is appropriate since images extend far beyond our region of interest.</p>
<p>The results are saved under <code>rtoi_path</code> inside Modis/mod09ga/mosaic (i.e. <em>constellation_name/data_product_name/mosaic</em>). This is the first time in the workflow that the <code>rtoi_path</code> is being used. The reason is that mosaicking is the first transformation applied to the raw images to better fit the particular needs of the analysis. The outcomes from the mosaic are compressed (<em>zip)</em> to minimize their size:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">ds.path</span>, <span class="st">"filomena"</span>, <span class="st">"Modis/mod09ga/mosaic"</span><span class="op">)</span>, full.name <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>At this point of the workflow, <em>RGB</em> representations of the satellite images can be displayed on the fly, without loading the entire image in <code>R</code>. By default, the <code><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot()</a></code> method for an <code>rtoi</code> displays the mosaicked images when the object is not followed by the words <code>"preview"</code> or <code>"date"</code> (see other types of plots for an <code>rtoi</code> in the search vignette):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">filomena</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-11"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The map shows a sample of pixels from the original image. This is a strategy to save space in <em>RAM</em> memory. The downside is the reduction in the level of detail of the image. By default, the number of pixels on the horizontal and vertical axis is <span class="math inline">\(250\)</span>. The arguments <code>xsize</code> and <code>ysize</code> change the size of the sample to vary the crispness of the image. The code below doubles the number of pixels on each axis of the image;</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">filomena</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-11"</span><span class="op">)</span>,xsize <span class="op">=</span> <span class="fl">500</span>, ysize <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span></code></pre></div>
<p>Clouds and snow are visually similar. False color images are frequently used in the field in order to ease the detection of features. False color images switch the natural color in the <em>RGB</em> image to other bands. These kind of representations can be built using the <code>band_name</code> argument followed by the name of the bands replacing the <em>red</em>, <em>green</em>, and <em>blue</em> colors. For instance, the rendering of <em>swir1</em>, <em>nir</em>, and <em>blue</em> highlights the snow in blue color:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">filomena</span>,</span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-11"</span><span class="op">)</span>,</span>
<span>     xsize <span class="op">=</span> <span class="fl">500</span>,</span>
<span>     ysize <span class="op">=</span> <span class="fl">500</span>,</span>
<span>     band_name <span class="op">=</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="st">"swir1"</span>, <span class="st">"nir"</span>, <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="index-calculation">Index calculation<a class="anchor" aria-label="anchor" href="#index-calculation"></a>
</h3>
<div class="section level4">
<h4 id="definition">Definition<a class="anchor" aria-label="anchor" href="#definition"></a>
</h4>
<p>A <strong><em>remote sensing index</em></strong> is an indicator that reveals the presence of a material in a satellite image. Indexes are the result of simple math applied to the bands of an image. The computation involves the bands with a distinctively high or low reflectance for the feature at hand. Over the years, researchers have developed a wide variety of indexes for different materials or processes which can be consulted <a href="https://www.indexdatabase.de/db/i.php" class="external-link">here</a>.</p>
<p>For instance, the <em>Normalized Difference Snow Index</em> (NDSI) (see e.g., <span class="citation">(Salomonson and Appel 2004)</span>) highlights the snow using the <em>green</em> and <em>shortwave-infrared</em> bands (around <span class="math inline">\(1.5 \mu m\)</span>). The subtraction of this two bands gives a large number for those pixels depicting snow. The denominator ensures that values oscillate between <span class="math inline">\(-1\)</span> and <span class="math inline">\(1\)</span>.</p>
<p><span class="math display">\[ NDSI = \frac{Green - SWIR1}{Green + SWIR1}\]</span></p>
</div>
<div class="section level4">
<h4 id="calculation">Calculation<a class="anchor" aria-label="anchor" href="#calculation"></a>
</h4>
<p>In <code>R</code> we can create a function replicating the calculation of the <em>NDSI</em> index<em>:</em></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NDSI</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">green</span>, <span class="va">swir1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">ndsi</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">green</span> <span class="op">-</span> <span class="va">swir1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">green</span> <span class="op">+</span> <span class="va">swir1</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">ndsi</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><code>rsat</code> demands that these formulas use the band names, e.g. <em>red, green, blue, etc.</em> rather than band number. Band names and numbers differ among mission/satellites. For instance, the <em>green</em> corresponds to the band number <span class="math inline">\(4\)</span> in MODIS and Landsat-7, number <span class="math inline">\(3\)</span> in Landsat-8 and Sentinel-2, and number <span class="math inline">\(6\)</span> in Sentinel-3 (see <a href="https://drive.google.com/file/d/1cSw4LaTLPlGBHmG8v7uwH54f-m9jZz1N/view?usp=sharing" class="external-link">here</a>). Using their names enables the use of a unique custom function across satellites/missions. <code>rsat</code> functions are responsible for linking the name to the corresponding band number according to the mission. Some widespread variables are built-in the package and the list of variables can be printed using;</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/show_variables.html">show_variables</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>To use the <code>NDSI()</code> function over the series of satellite images of the Iberian peninsula, use the function <code>derive()</code> as follows;</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rsat_derive.html">rsat_derive</a></span><span class="op">(</span><span class="va">filomena</span>, product <span class="op">=</span> <span class="st">"mod09ga"</span>, variable <span class="op">=</span> <span class="st">"ndsi"</span>, fun <span class="op">=</span> <span class="va">NDSI</span><span class="op">)</span></span></code></pre></div>
<p>Again, you can plot the results without loading the scenes in <code>R</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">filomena</span>,</span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-11"</span><span class="op">)</span>,</span>
<span>     variable <span class="op">=</span> <span class="st">"ndsi"</span>,</span>
<span>     xsize <span class="op">=</span> <span class="fl">500</span>,</span>
<span>     ysize <span class="op">=</span> <span class="fl">500</span>,</span>
<span>     zlim <span class="op">=</span> <span class="fu"><a href="../reference/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <em>NDSI</em> index improves the separability between clouds and snow. However, there might be some difficulties distinguishing between them in certain parts of the image. As a solution, the next step removes cloud-covered pixels.</p>
</div>
</div>
<div class="section level3">
<h3 id="cloud-removal">Cloud removal<a class="anchor" aria-label="anchor" href="#cloud-removal"></a>
</h3>
<p>Some data providers apply algorithms over their data-sets to detect the presence of clouds (Level 1/2 products). The analysis is part of the quality assessment done during pre-processing and the results are included in the <strong><em>Quality Assurance</em></strong> (<em>QA</em>) band of the image. In addition to cloud coverage, the band provides information about over-saturated or filled pixels. The information is packed in this band using the bit format.</p>
<p>The function <code>cloud_mask()</code> interprets the <em>QA</em> band to obtain images showing the presence/absence of clouds. Its application is straightforward;</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rsat_cloudMask.html">rsat_cloudMask</a></span><span class="op">(</span><span class="va">filomena</span><span class="op">)</span></span></code></pre></div>
<p>To apply the cloud mask, we need to import the <em>NDSI</em> images into <code>R</code> using the <code>get_raster()</code> function. The values of the index must be truncated between <span class="math inline">\(-1\)</span> and <span class="math inline">\(1\)</span> to avoid values outside the feasible range (sun reflections on mirror-like surfaces, such as water, can lead to misleading results):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ndsi.img</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_data.html">rsat_get_raster</a></span><span class="op">(</span><span class="va">filomena</span>, <span class="st">"mod09ga"</span>, <span class="st">"ndsi"</span><span class="op">)</span></span>
<span><span class="va">ndsi.img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/clamp.html" class="external-link">clamp</a></span><span class="op">(</span><span class="va">ndsi.img</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>For every image in the <code>rtoi</code>, the <code>cloud_mask()</code> function generates a new image, called <strong><em>mask</em></strong>, in which <span class="math inline">\(1\)</span>s and <span class="math inline">\(NA\)</span>s indicate clear and covered pixels. The function identifies the mission/program and applies the appropriate interpretation of bits to create the cloud mask. To import the result run;</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clds.msk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_data.html">rsat_get_raster</a></span><span class="op">(</span><span class="va">filomena</span>, <span class="st">"mod09ga"</span>, <span class="st">"CloudMask"</span><span class="op">)</span></span></code></pre></div>
<p>In MODIS, cloud-masks have a different resolution than the multispectral image. To adjust the resolution, <em>resample</em> the cloud mask to match the resolution of the <em>NDSI</em> images (<code><a href="https://rspatial.github.io/terra/reference/resample.html" class="external-link">resample()</a></code>) using the nearest neighbor method (<code>"ngb"</code>):</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clds.msk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">clds.msk</span>, <span class="va">ndsi.img</span>, method <span class="op">=</span> <span class="st">"ngb"</span><span class="op">)</span></span></code></pre></div>
<p>To apply the cloud mask, we just multiply both series of pixels. Dot multiplications are performed pixel-wise. <em>NDSI</em> values multiplied by <span class="math inline">\(1\)</span> remain unaltered but those multiplied by <span class="math inline">\(NA\)</span> become missing:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ndsi.filt</span> <span class="op">&lt;-</span> <span class="va">ndsi.img</span> <span class="op">*</span> <span class="va">clds.msk</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ndsi.filt</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clds.msk</span><span class="op">)</span> <span class="co"># keep the names</span></span></code></pre></div>
<p>As an attempt to obtain a <strong><em>composite image</em></strong>, we extract maximum value of the <em>NDSI</em> for each pixel in the time series. Maximum value compositions are frequent in this field <span class="citation">(Holben 1986)</span>. Compositing is as a way to summarize the information in a time-lapse and ignore the presence of clouds:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">snow.spain</span> <span class="op">&lt;-</span> <span class="fu">calc</span><span class="op">(</span><span class="va">ndsi.filt</span>, <span class="va">max</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Represent the results:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/" class="external-link">tmap</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">snow.spain</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_raster.html" class="external-link">tm_raster</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span></span></code></pre></div>
<p>The results are not completely satisfactory. The image shows unfilled gaps and this is because for those pixels there is no valid information along the time-series. The following vignette explains how to process images to fill gaps and smooth outliers.</p>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-holben1986characteristics" class="csl-entry">
Holben, Brent N. 1986. <span>“Characteristics of Maximum-Value Composite Images from Temporal AVHRR Data.”</span> <em>International Journal of Remote Sensing</em> 7 (11): 1417–34.
</div>
<div id="ref-salomonson2004estimating" class="csl-entry">
Salomonson, Vincent V, and I Appel. 2004. <span>“Estimating Fractional Snow Cover from MODIS Using the Normalized Difference Snow Index.”</span> <em>Remote Sensing of Environment</em> 89 (3): 351–60.
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
